<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Mermaid Diagram App</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Mermaid from CDN; replace src with local path if you want offline use -->
  <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
  <style>
    :root {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f5f5f5;
      color: #222;
    }
    body {
      margin: 0;
      padding: 0;
    }
    .app {
      display: grid;
      grid-template-columns: minmax(300px, 1fr) minmax(400px, 1.3fr);
      gap: 12px;
      padding: 12px;
      height: 100vh;
      box-sizing: border-box;
    }
    @media (max-width: 900px) {
      .app {
        grid-template-columns: 1fr;
        grid-template-rows: auto 1fr;
      }
    }
    .panel {
      background: #ffffff;
      border-radius: 6px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    .panel-header {
      padding: 8px 12px;
      border-bottom: 1px solid #e0e0e0;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }
    .panel-header h1,
    .panel-header h2 {
      font-size: 14px;
      margin: 0;
      font-weight: 600;
    }
    .panel-body {
      flex: 1;
      padding: 8px;
      overflow: auto;
    }
    textarea {
      width: 100%;
      height: 100%;
      min-height: 200px;
      box-sizing: border-box;
      resize: none;
      border: none;
      outline: none;
      font-family: "Fira Code", "Consolas", "Menlo", monospace;
      font-size: 12px;
      line-height: 1.4;
    }
    button {
      padding: 4px 10px;
      font-size: 12px;
      border-radius: 4px;
      border: 1px solid #145c22;
      background: #1b7a30;
      color: #fff;
      cursor: pointer;
      white-space: nowrap;
    }
    button:hover {
      background: #145c22;
    }
    .secondary {
      border-color: #666;
      background: #fff;
      color: #222;
    }
    .secondary:hover {
      background: #f0f0f0;
    }
    .hint {
      font-size: 11px;
      color: #555;
    }
    #diagram {
      width: 100%;
      min-height: 200px;
    }
    #error {
      padding: 4px 8px;
      font-size: 11px;
      color: #8b2420;
      border-top: 1px solid #f0c5c3;
      background: #fde2e1;
      display: none;
      white-space: pre-wrap;
    }
  </style>
</head>
<body>
<div class="app">
  <!-- Left: Mermaid text input -->
  <div class="panel">
    <div class="panel-header">
      <h1>Mermaid Source</h1>
      <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;">
        <span class="hint">Ctrl+Enter to render</span>
        <button type="button" onclick="renderMermaid()">Render</button>
      </div>
    </div>
    <div class="panel-body">
      <textarea id="mermaid-input" spellcheck="false">
flowchart TD
    A["Start: Draft RPS screening"] --> B{"Distance to surface water < 50 m?"}
    B -->|Yes| R1["RPS FAIL\nWithin 50 m of surface water\nFull Schedule 33 consent"]
    B -->|No| C{"GWDTE or designated site\nwithin 500 m?"}

    C -->|Yes| R2["RPS FAIL\nWithin 500 m of GWDTE / designated site"]
    C -->|No| D{"Landfill or contamination present?\nLandfill or other contamination identified"}

    D -->|Yes| R3["RPS FAIL\nBrownfield / contamination present"]
    D -->|No| E{"Bentonite in SPZ2 or SPZ3?\nSupport fluid is bentonite and site in SPZ2/3"}

    E -->|Yes| R4["RPS FAIL\nBentonite use in SPZ2/3\nExcluded under draft RPS"]
    E -->|No| F{"Flood Zone 3 works longer than 28 days?\nWorks in FZ3 for more than 28 days"}

    F -->|Yes| R5["RPS FAIL\nFlood Zone 3 works > 28 days"]
    F -->|No| G{"SPZ1?\nSite within SPZ1?"}

    G -->|Yes| R6["RPS FAIL\nSPZ1 – specific consent required"]
    G -->|No| ROK["RPS ELIGIBLE\n(subject to EA agreement)"]

    classDef fail fill:#fde2e1,stroke:#8b2420,color:#8b2420;
    classDef ok fill:#dff5e3,stroke:#145c22,color:#145c22;
    class R1,R2,R3,R4,R5,R6 fail;
    class ROK ok;
      </textarea>
    </div>
  </div>

  <!-- Right: Rendered diagram -->
  <div class="panel">
    <div class="panel-header">
      <h2>Diagram Preview</h2>
      <div style="display:flex;align-items:center;gap:6px;flex-wrap:wrap;">
        <button type="button" class="secondary" onclick="downloadSVG()">Download SVG</button>
        <button type="button" class="secondary" onclick="downloadPNG()">Download PNG</button>
      </div>
    </div>
    <div class="panel-body">
      <div id="diagram">
        <p class="hint">Paste Mermaid code on the left and click “Render”.</p>
      </div>
    </div>
    <div id="error"></div>
  </div>
</div>

<script>
  // Initialise Mermaid in manual mode
  mermaid.initialize({
    startOnLoad: false,
    securityLevel: "loose",
    theme: "default"
  });

  function cleanMermaidSource(raw) {
    // Strip leading blank lines and // or # comments
    const lines = raw.split(/\r?\n/);
    const cleaned = [];
    let started = false;

    for (const line of lines) {
      const t = line.trim();
      if (!started) {
        if (!t) continue;
        if (t.startsWith("//") || t.startsWith("#")) continue;
        started = true;
        cleaned.push(line);
      } else {
        cleaned.push(line);
      }
    }
    return cleaned.join("\n");
  }

  async function renderMermaid() {
    const inputEl = document.getElementById("mermaid-input");
    const diagramEl = document.getElementById("diagram");
    const errorEl = document.getElementById("error");

    const rawCode = inputEl.value;
    const code = cleanMermaidSource(rawCode).trim();

    errorEl.style.display = "none";
    errorEl.textContent = "";
    diagramEl.innerHTML = "";

    if (!code) {
      diagramEl.innerHTML = '<p class="hint">No Mermaid code provided.</p>';
      return;
    }

    try {
      const id = "mermaid-diagram-" + Date.now();

      const { svg, bindFunctions } = await mermaid.render(id, code);

      diagramEl.innerHTML = svg;
      if (typeof bindFunctions === "function") {
        bindFunctions(diagramEl);
      }
    } catch (err) {
      console.error(err);
      errorEl.textContent =
        "Error rendering Mermaid diagram:\n" +
        (err && err.message ? err.message : String(err));
      errorEl.style.display = "block";
    }
  }

  function getCurrentSVG() {
    const diagramEl = document.getElementById("diagram");
    return diagramEl.querySelector("svg");
  }

  function downloadSVG() {
    const svgEl = getCurrentSVG();
    if (!svgEl) {
      alert("No diagram to export. Render one first.");
      return;
    }

    const serializer = new XMLSerializer();
    let source = serializer.serializeToString(svgEl);

    // Ensure xmlns attribute is present
    if (!source.match(/^<svg[^>]+xmlns="/)) {
      source = source.replace(
        /^<svg/,
        '<svg xmlns="http://www.w3.org/2000/svg"'
      );
    }

    const blob = new Blob([source], { type: "image/svg+xml;charset=utf-8" });
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = "diagram.svg";
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  function downloadPNG() {
    const svgEl = getCurrentSVG();
    if (!svgEl) {
      alert("No diagram to export. Render one first.");
      return;
    }

    const serializer = new XMLSerializer();
    const svgString = serializer.serializeToString(svgEl);
    const svgBlob = new Blob([svgString], { type: "image/svg+xml;charset=utf-8" });
    const url = URL.createObjectURL(svgBlob);

    const img = new Image();
    img.onload = function () {
      const viewBox = svgEl.viewBox && svgEl.viewBox.baseVal;
      const width = viewBox && viewBox.width ? viewBox.width : svgEl.getBoundingClientRect().width || 800;
      const height = viewBox && viewBox.height ? viewBox.height : svgEl.getBoundingClientRect().height || 600;

      const canvas = document.createElement("canvas");
      canvas.width = width;
      canvas.height = height;
      const ctx = canvas.getContext("2d");
      ctx.drawImage(img, 0, 0, width, height);
      URL.revokeObjectURL(url);

      canvas.toBlob(function (blob) {
        const pngUrl = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = pngUrl;
        a.download = "diagram.png";
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(pngUrl);
      }, "image/png");
    };
    img.onerror = function (e) {
      console.error(e);
      alert("Failed to export PNG from SVG.");
      URL.revokeObjectURL(url);
    };
    img.src = url;
  }

  // Ctrl+Enter shortcut
  document.addEventListener("keydown", (e) => {
    if ((e.ctrlKey || e.metaKey) && e.key === "Enter") {
      e.preventDefault();
      renderMermaid();
    }
  });

  // Auto-render initial example once page is loaded
  window.addEventListener("load", () => {
    renderMermaid();
  });
</script>
</body>
</html>
